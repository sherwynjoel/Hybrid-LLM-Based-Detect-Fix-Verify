"""Generate Proof-of-Concept exploits for vulnerability verification"""

from typing import Dict, Optional
import re

from src.llm_models.chatgpt_cloud import ChatGPTCloud
from src.utils.config import config


class ExploitGenerator:
    """Generate PoC exploits for testing vulnerabilities"""
    
    def __init__(self):
        self.chatgpt = ChatGPTCloud()
    
    def generate_exploit(self, code: str, vulnerability: Dict, language: str) -> Dict:
        """Generate PoC exploit for vulnerability"""
        
        # Use ChatGPT for exploit generation (more reliable for security testing)
        if self.chatgpt.is_available():
            return self.chatgpt.generate_exploit(code, vulnerability, language)
        
        # Fallback to pattern-based exploit generation
        return self._generate_pattern_based_exploit(code, vulnerability, language)
    
    def _generate_pattern_based_exploit(self, code: str, vulnerability: Dict, 
                                       language: str) -> Dict:
        """Generate exploit based on vulnerability patterns"""
        
        cwe = vulnerability.get('cwe', '')
        line_num = vulnerability.get('line', 0)
        exploit_code = ""
        
        if cwe == 'CWE-89':  # SQL Injection
            exploit_code = self._generate_sql_injection_exploit(code, line_num, language)
        elif cwe == 'CWE-79':  # XSS
            exploit_code = self._generate_xss_exploit(code, line_num, language)
        elif cwe == 'CWE-78':  # Command Injection
            exploit_code = self._generate_command_injection_exploit(code, line_num, language)
        elif cwe == 'CWE-22':  # Path Traversal
            exploit_code = self._generate_path_traversal_exploit(code, line_num, language)
        elif cwe == 'CWE-119':  # Buffer Overflow
            exploit_code = self._generate_buffer_overflow_exploit(code, line_num, language)
        else:
            exploit_code = f"# Generic exploit test for {cwe}\n# Manual testing required"
        
        return {
            'exploit_code': exploit_code,
            'success': True,
            'method': 'pattern-based'
        }
    
    def _generate_sql_injection_exploit(self, code: str, line_num: int, language: str) -> str:
        """Generate SQL injection exploit"""
        if language == 'python':
            return """# SQL Injection PoC
malicious_input = "1' OR '1'='1"
# Test with: query(malicious_input)
# Expected: Should return all rows or cause error
"""
        else:
            return """// SQL Injection PoC
char* malicious_input = "1' OR '1'='1";
// Test with vulnerable query function
// Expected: Should return all rows or cause error
"""
    
    def _generate_xss_exploit(self, code: str, line_num: int, language: str) -> str:
        """Generate XSS exploit"""
        return """# XSS PoC
malicious_input = "<script>alert('XSS')</script>"
# Test by injecting into vulnerable output
# Expected: Script should execute in browser
"""
    
    def _generate_command_injection_exploit(self, code: str, line_num: int, language: str) -> str:
        """Generate command injection exploit"""
        if language == 'python':
            return """# Command Injection PoC
malicious_input = "; ls -la"
# Test with: os.system(malicious_input)
# Expected: Should execute arbitrary command
"""
        else:
            return """// Command Injection PoC
char* malicious_input = "; ls -la";
// Test with system() or exec() function
// Expected: Should execute arbitrary command
"""
    
    def _generate_path_traversal_exploit(self, code: str, line_num: int, language: str) -> str:
        """Generate path traversal exploit"""
        return """# Path Traversal PoC
malicious_path = "../../../etc/passwd"
# Test with file operations
# Expected: Should access files outside intended directory
"""
    
    def _generate_buffer_overflow_exploit(self, code: str, line_num: int, language: str) -> str:
        """Generate buffer overflow exploit"""
        return """// Buffer Overflow PoC
char large_buffer[1000];
memset(large_buffer, 'A', 999);
large_buffer[999] = '\\0';
// Test with vulnerable strcpy/strcat
// Expected: Should cause buffer overflow
"""



